<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Analysis | VETTX</title>
    <link rel="icon" type="image/x-icon" href="https://www.vettx.com/favicon.ico">
    <link rel="icon" type="image/png" href="https://cdn.prod.website-files.com/6813c1400a0cd2b3d0b4ba2b/6813c1400a0cd2b3d0b4ba54_Favicon%2032.png" sizes="32x32">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@700,500,400&display=swap" rel="stylesheet">
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            /* Brand Colors */
            --vettx-dark-1: #181D31;
            --vettx-dark-2: #494D5F;
            --vettx-dark-3: #888F97;
            --vettx-light-1: #FFFFFF;
            --vettx-light-2: #F6F8FA;
            --vettx-light-3: #D8DEE3;
            --vettx-brand: #009EF7;
            /* Mapped variables */
            --vettx-navy: var(--vettx-dark-1);
            --vettx-navy-light: var(--vettx-dark-2);
            --vettx-accent: var(--vettx-brand);
            --vettx-text: var(--vettx-dark-2);
            --vettx-text-light: var(--vettx-dark-3);
            --vettx-border: var(--vettx-light-3);
            --vettx-bg: var(--vettx-light-2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--vettx-bg);
        }

        h1, h2, h3, .logo {
            font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: var(--vettx-navy);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .logo img {
            height: 28px;
            width: auto;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 0.875rem;
        }

        .controls {
            background: white;
            padding: 20px;
            border-bottom: 1px solid var(--vettx-border);
            z-index: 10;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            font-size: 0.8125rem;
            color: var(--vettx-text-light);
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--vettx-border);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--vettx-accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--vettx-navy) 0%, var(--vettx-navy-light) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .radius-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .radius-slider {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .radius-slider input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: var(--vettx-border);
            border-radius: 2px;
            border: none;
            padding: 0;
        }

        .radius-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--vettx-navy);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .radius-slider input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--vettx-navy);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .radius-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radius-input-group input[type="number"] {
            width: 80px;
            padding: 8px 10px;
            border: 1px solid var(--vettx-border);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            text-align: center;
        }

        .radius-input-group input[type="number"]:focus {
            outline: none;
            border-color: var(--vettx-accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .radius-input-group span {
            color: var(--vettx-text-light);
            font-weight: 500;
        }

        #map {
            flex: 1;
            min-height: 400px;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker input[type="color"] {
            width: 44px;
            height: 38px;
            border: 1px solid var(--vettx-border);
            border-radius: 6px;
            cursor: pointer;
            padding: 3px;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
            font-size: 0.875rem;
            border: 1px solid #fecaca;
        }

        .error-message.show {
            display: block;
        }

        .info-text {
            font-size: 0.75rem;
            color: var(--vettx-text-light);
            margin-top: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility classes for form layout */
        .form-group--address { flex: 2; }
        .form-group--unit { flex: 0.5; min-width: 120px; }
        .form-group--color { flex: 0.5; min-width: 100px; }
        .form-group--radius { flex: 1; }
        .form-row--spacing { margin-top: 15px; }

        /* Export button */
        .btn--export {
            background: linear-gradient(135deg, #009EF7 0%, #0085d1 100%);
            display: none;
        }

        .btn--export.show {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn--export:hover {
            box-shadow: 0 4px 12px rgba(0, 158, 247, 0.3);
        }

        .btn--export:disabled {
            background: #94a3b8;
        }

        .btn--export svg {
            width: 16px;
            height: 16px;
        }

        /* Summary Bar */
        .summary-bar {
            background: linear-gradient(135deg, var(--vettx-navy) 0%, #1a2744 100%);
            color: white;
            display: none;
            flex-direction: column;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .summary-bar.show {
            display: flex;
        }

        .summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            cursor: pointer;
        }

        .summary-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .summary-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .summary-circle-count {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .summary-expand-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .summary-expand-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .summary-expand-btn svg {
            width: 12px;
            height: 12px;
            transition: transform 0.2s;
        }

        .summary-bar.expanded .summary-expand-btn svg {
            transform: rotate(180deg);
        }

        .summary-details {
            display: none;
            padding: 12px 20px;
            background: rgba(0,0,0,0.15);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .summary-bar.expanded .summary-details {
            display: block;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .summary-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .summary-stat-value {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--vettx-accent);
        }

        .summary-stat-label {
            opacity: 0.7;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-manage {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            opacity: 0.8;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .summary-manage:hover {
            opacity: 1;
            background: rgba(255,255,255,0.1);
        }

        .summary-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .summary-toggle svg {
            width: 16px;
            height: 16px;
        }

        /* Circles Drawer */
        .circles-drawer {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 320px;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .circles-drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--vettx-border);
            background: var(--vettx-bg);
            flex-shrink: 0;
        }

        .drawer-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--vettx-navy);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drawer-header .circle-count {
            color: var(--vettx-text-light);
            font-weight: 400;
            font-size: 0.875rem;
        }

        .drawer-close {
            width: 32px;
            height: 32px;
            padding: 0;
            background: none;
            border: none;
            color: var(--vettx-text-light);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .drawer-close:hover {
            background: var(--vettx-bg);
            color: var(--vettx-navy);
        }

        .drawer-close svg {
            width: 20px;
            height: 20px;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .drawer-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--vettx-border);
            background: var(--vettx-bg);
            flex-shrink: 0;
        }

        .btn--clear-all {
            width: 100%;
            padding: 8px 16px;
            font-size: 0.8125rem;
            background: white;
            color: #dc2626;
            border: 1px solid #dc2626;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn--clear-all:hover {
            background: #dc2626;
            color: white;
        }

        /* Drawer Toggle Button */
        .drawer-toggle {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 80px;
            background: var(--vettx-navy);
            border: none;
            border-radius: 8px 0 0 8px;
            color: white;
            cursor: pointer;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            z-index: 999;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .drawer-toggle.show {
            display: flex;
        }

        .drawer-toggle:hover {
            width: 44px;
            background: #1a2744;
        }

        .drawer-toggle svg {
            width: 20px;
            height: 20px;
            transition: transform 0.3s;
        }

        .drawer-toggle.open svg {
            transform: rotate(180deg);
        }

        .drawer-toggle .circle-badge {
            background: var(--vettx-accent);
            color: white;
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .circle-card {
            padding: 12px;
            background: var(--vettx-bg);
            border-radius: 8px;
            margin-bottom: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .circle-card:hover {
            border-color: var(--vettx-border);
        }

        .circle-card.active {
            border-color: var(--vettx-accent);
            background: rgba(0, 158, 247, 0.05);
        }

        .circle-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .circle-card-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .circle-card-address {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--vettx-navy);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .circle-card-delete {
            width: 24px;
            height: 24px;
            padding: 0;
            background: none;
            border: none;
            color: var(--vettx-text-light);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .circle-card-delete:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .circle-card-delete svg {
            width: 16px;
            height: 16px;
        }

        .circle-card-listings {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: linear-gradient(135deg, var(--vettx-navy) 0%, #1a2744 100%);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .circle-card-listings-icon {
            font-size: 1.25rem;
        }

        .circle-card-listings-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--vettx-accent);
        }

        .circle-card-listings-label {
            font-size: 0.6875rem;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }

        .circle-card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .circle-card-metric {
            display: flex;
            flex-direction: column;
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid var(--vettx-border);
        }

        .circle-card-metric-value {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--vettx-navy);
        }

        .circle-card-metric-label {
            font-size: 0.625rem;
            color: var(--vettx-text-light);
            text-transform: uppercase;
        }

        .circle-card-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--vettx-border);
        }

        .circle-card-controls label {
            font-size: 0.6875rem;
            color: var(--vettx-text-light);
            text-transform: uppercase;
        }

        .circle-card-radius {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid var(--vettx-border);
            border-radius: 4px;
            font-size: 0.8125rem;
            text-align: center;
        }

        .circle-card-unit {
            font-size: 0.75rem;
            color: var(--vettx-text-light);
        }

        @media (max-width: 768px) {
            .container {
                height: auto;
                min-height: 100vh;
            }

            .form-group {
                min-width: 100%;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .controls {
                padding: 15px;
            }

            #map {
                min-height: 300px;
            }

            .circles-drawer {
                width: 100%;
                max-width: 320px;
            }

            .drawer-toggle {
                display: none !important;
            }

            .summary-bar {
                cursor: pointer;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="https://www.vettx.com" class="logo" target="_blank"><img src="logo.png" alt="VETTX"></a>
            <span class="header-subtitle">Market Analysis</span>
        </div>
        <div class="controls">
            <div class="form-row">
                <div class="form-group form-group--address">
                    <label for="address">Address</label>
                    <input type="text" id="address" placeholder="Enter an address..." autocomplete="off">
                </div>
                <div class="form-group form-group--unit">
                    <label for="unit">Unit</label>
                    <select id="unit">
                        <option value="miles">Miles</option>
                        <option value="km">Kilometers</option>
                    </select>
                </div>
                <div class="form-group form-group--color">
                    <label for="color">Circle Color</label>
                    <div class="color-picker">
                        <input type="color" id="color" value="#0f172a">
                    </div>
                </div>
                <button class="btn" id="searchBtn">Add Circle</button>
                <button class="btn btn--export" id="exportBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Export PDF
                </button>
            </div>
            <div class="form-row form-row--spacing">
                <div class="form-group form-group--radius">
                    <label>Radius</label>
                    <div class="radius-control">
                        <div class="radius-slider">
                            <input type="range" id="radiusSlider" min="1" max="500" step="1" value="25">
                        </div>
                        <div class="radius-input-group">
                            <input type="number" id="radiusInput" min="1" max="10000" step="1" value="25">
                            <span id="unitDisplay">miles</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="error-message" id="error"></div>
            <p class="info-text">Enter an address and click "Add Circle" to add a market area. Add multiple circles to compare regions.</p>
        </div>
        <!-- Summary Bar -->
        <div class="summary-bar" id="summaryBar">
            <div class="summary-header">
                <div class="summary-header-left">
                    <span class="summary-circle-count" id="summaryCircleCount">0 circles</span>
                    <button class="summary-expand-btn" id="summaryExpandBtn">
                        <span id="summaryExpandText">Show Details</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                <div class="summary-manage" id="summaryToggle">
                    <span>Manage Circles</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:16px;height:16px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </div>
            </div>
            <div class="summary-details" id="summaryDetails">
                <div class="summary-stats">
                    <div class="summary-stat">
                        <span class="summary-stat-value" id="summaryListings">~0</span>
                        <span class="summary-stat-label">Est. Listings/Mo</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-value" id="summaryPopulation">0</span>
                        <span class="summary-stat-label">Total Population</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-value" id="summaryArea">0</span>
                        <span class="summary-stat-label">Total Area (miÂ²)</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-value" id="summaryCounties">0</span>
                        <span class="summary-stat-label">Counties Covered</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-value" id="summaryStates">0</span>
                        <span class="summary-stat-label">States Covered</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-value" id="summaryDensity">0</span>
                        <span class="summary-stat-label">Avg Density/miÂ²</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="map"></div>

        <!-- Drawer Toggle Button -->
        <button class="drawer-toggle" id="drawerToggle">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="circle-badge" id="drawerBadge">0</span>
        </button>

        <!-- Circles Drawer -->
        <div class="circles-drawer" id="circlesDrawer">
            <div class="drawer-header">
                <h3>Market Areas <span class="circle-count" id="circleCount">(0)</span></h3>
                <button class="drawer-close" id="drawerClose">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="drawer-content" id="drawerContent">
                <!-- Circle cards will be inserted here -->
            </div>
            <div class="drawer-footer" id="drawerFooter">
                <button class="btn--clear-all" id="clearAllBtn">Clear All Circles</button>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const METERS_PER_MILE = 1609.34;
        const METERS_PER_KM = 1000;
        const LISTINGS_PER_MILLION = 500;
        const DEBOUNCE_DELAY = 300;
        const ANIMATION_DURATION = 800;
        const CIRCLE_ANIMATION_DURATION = 600;
        const EARTH_RADIUS_MILES = 3959; // Earth's radius in miles

        // Cached DOM elements (initialized in initMap)
        const elements = {};

        // Global state
        let map;
        let geocoder;
        let allCounties = null; // Pre-loaded county data

        // Multiple circles support
        let circles = []; // Array of circle objects: { id, circle, marker, radius, color, address, censusData }
        let activeCircleId = null; // Currently selected circle
        let nextCircleId = 1;
        let populationUpdateTimeout = null;

        // Haversine formula to calculate distance between two lat/lng points in miles
        function haversineDistance(lat1, lng1, lat2, lng2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return EARTH_RADIUS_MILES * c;
        }

        // Find all counties within a radius of a center point
        function findCountiesInRadius(centerLat, centerLng, radiusMiles) {
            if (!allCounties) return [];
            return allCounties.filter(county => {
                const distance = haversineDistance(centerLat, centerLng, county.lat, county.lng);
                return distance <= radiusMiles;
            }).map(county => ({
                ...county,
                distance: haversineDistance(centerLat, centerLng, county.lat, county.lng)
            })).sort((a, b) => a.distance - b.distance);
        }

        // Load county data
        async function loadCountyData() {
            try {
                const response = await fetch('counties.json');
                allCounties = await response.json();
                console.log(`Loaded ${allCounties.length} counties`);
            } catch (error) {
                console.error('Failed to load county data:', error);
            }
        }

        // Utility functions
        const formatNumber = (num) => num.toLocaleString();

        function getRadiusInMeters(radiusValue, unit) {
            return unit === 'miles' ? radiusValue * METERS_PER_MILE : radiusValue * METERS_PER_KM;
        }

        function getRadiusFromMeters(meters, unit) {
            return unit === 'miles' ? meters / METERS_PER_MILE : meters / METERS_PER_KM;
        }

        // Animate circle radius expansion
        function animateCircleRadius(startRadius, endRadius, duration, onComplete) {
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // Ease out cubic for smooth deceleration
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentRadius = startRadius + (endRadius - startRadius) * easeOut;

                if (circle) {
                    circle.setRadius(currentRadius);
                }

                if (progress < 1) {
                    requestAnimationFrame(update);
                } else if (onComplete) {
                    onComplete();
                }
            }
            requestAnimationFrame(update);
        }

        // Animated counter for listings
        function animateCounterListings(element, target, duration = 1000) {
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(target * easeOut);
                element.textContent = '~' + current.toLocaleString() + ' listings/mo';

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            requestAnimationFrame(update);
        }

        // Get emoji based on listings count
        function getListingsEmoji(listings) {
            if (listings >= 500) return 'ðŸš—';
            if (listings >= 250) return 'ðŸš™';
            if (listings >= 100) return 'ðŸš';
            if (listings >= 50) return 'ðŸ›»';
            if (listings >= 10) return 'ðŸš˜';
            return 'ðŸš•';
        }

        // URL parameter handling
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                address: params.get('address'),
                radius: params.get('radius'),
                unit: params.get('unit'),
                color: params.get('color')
            };
        }

        function updateUrl() {
            const address = elements.address.value.trim();
            if (!address) return;

            const params = new URLSearchParams();
            params.set('address', address);
            params.set('radius', elements.radiusInput.value);
            params.set('unit', elements.unit.value);
            params.set('color', elements.color.value);

            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, '', newUrl);
        }

        function loadFromUrl() {
            const params = getUrlParams();

            if (params.radius) {
                elements.radiusInput.value = params.radius;
                elements.radiusSlider.value = Math.min(params.radius, 500);
            }
            if (params.unit) {
                elements.unit.value = params.unit;
                elements.unitDisplay.textContent = params.unit;
            }
            if (params.color) {
                elements.color.value = params.color;
            }
            if (params.address) {
                elements.address.value = params.address;
                setTimeout(() => searchAddress(), 500);
            }
        }

        function cacheElements() {
            elements.address = document.getElementById('address');
            elements.radiusSlider = document.getElementById('radiusSlider');
            elements.radiusInput = document.getElementById('radiusInput');
            elements.unit = document.getElementById('unit');
            elements.unitDisplay = document.getElementById('unitDisplay');
            elements.color = document.getElementById('color');
            elements.searchBtn = document.getElementById('searchBtn');
            elements.error = document.getElementById('error');
            elements.exportBtn = document.getElementById('exportBtn');
            // Summary bar elements
            elements.summaryBar = document.getElementById('summaryBar');
            elements.summaryCircleCount = document.getElementById('summaryCircleCount');
            elements.summaryExpandBtn = document.getElementById('summaryExpandBtn');
            elements.summaryExpandText = document.getElementById('summaryExpandText');
            elements.summaryListings = document.getElementById('summaryListings');
            elements.summaryPopulation = document.getElementById('summaryPopulation');
            elements.summaryArea = document.getElementById('summaryArea');
            elements.summaryCounties = document.getElementById('summaryCounties');
            elements.summaryStates = document.getElementById('summaryStates');
            elements.summaryDensity = document.getElementById('summaryDensity');
            elements.summaryToggle = document.getElementById('summaryToggle');
            // Drawer elements
            elements.circlesDrawer = document.getElementById('circlesDrawer');
            elements.drawerContent = document.getElementById('drawerContent');
            elements.drawerToggle = document.getElementById('drawerToggle');
            elements.drawerBadge = document.getElementById('drawerBadge');
            elements.drawerClose = document.getElementById('drawerClose');
            elements.drawerFooter = document.getElementById('drawerFooter');
            elements.circleCount = document.getElementById('circleCount');
            elements.clearAllBtn = document.getElementById('clearAllBtn');
        }

        let drawerOpen = false;
        let summaryExpanded = false;

        function toggleDrawer() {
            drawerOpen = !drawerOpen;
            elements.circlesDrawer.classList.toggle('open', drawerOpen);
            elements.drawerToggle.classList.toggle('open', drawerOpen);
        }

        function toggleSummaryExpand() {
            summaryExpanded = !summaryExpanded;
            elements.summaryBar.classList.toggle('expanded', summaryExpanded);
            elements.summaryExpandText.textContent = summaryExpanded ? 'Hide Details' : 'Show Details';
        }

        function openDrawer() {
            drawerOpen = true;
            elements.circlesDrawer.classList.add('open');
            elements.drawerToggle.classList.add('open');
        }

        function closeDrawer() {
            drawerOpen = false;
            elements.circlesDrawer.classList.remove('open');
            elements.drawerToggle.classList.remove('open');
        }

        function initMap() {
            cacheElements();

            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 39.8283, lng: -98.5795 },
                zoom: 4,
                mapId: 'VETTX_MAP',
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            geocoder = new window.GeocoderClass();

            // Event listeners
            elements.searchBtn.addEventListener('click', searchAddress);
            elements.address.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchAddress();
            });
            elements.radiusSlider.addEventListener('input', handleRadiusChange);
            elements.radiusInput.addEventListener('input', handleRadiusChange);
            elements.unit.addEventListener('change', handleUnitChange);
            elements.color.addEventListener('input', handleColorChange);
            elements.exportBtn.addEventListener('click', exportToPDF);
            // Drawer event listeners
            elements.drawerToggle.addEventListener('click', toggleDrawer);
            elements.drawerClose.addEventListener('click', closeDrawer);
            elements.summaryToggle.addEventListener('click', toggleDrawer);
            elements.summaryExpandBtn.addEventListener('click', toggleSummaryExpand);
            elements.clearAllBtn.addEventListener('click', clearAllCircles);

            // Autocomplete
            const autocomplete = new window.AutocompleteClass(
                elements.address,
                { types: ['geocode'] }
            );

            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    const address = place.formatted_address || place.name || elements.address.value;
                    addCircle(place.geometry.location, address);
                }
            });

            loadFromUrl();
        }

        function searchAddress() {
            const address = elements.address.value.trim();
            if (!address) {
                showError('Please enter an address');
                return;
            }

            hideError();
            setSearchButtonState(true);

            geocoder.geocode({ address }, (results, status) => {
                setSearchButtonState(false);

                if (status === 'OK' && results[0]) {
                    const formattedAddress = results[0].formatted_address || address;
                    addCircle(results[0].geometry.location, formattedAddress);
                    elements.address.value = ''; // Clear input for next circle
                } else {
                    showError('Address not found. Please try a different address.');
                }
            });
        }

        function setSearchButtonState(isSearching) {
            elements.searchBtn.disabled = isSearching;
            elements.searchBtn.textContent = isSearching ? 'Searching...' : 'Add Circle';
        }

        function addCircle(location, address) {
            const id = nextCircleId++;
            const radiusValue = parseFloat(elements.radiusInput.value) || 25;
            const unit = elements.unit.value;
            const targetRadius = getRadiusInMeters(radiusValue, unit);
            const color = elements.color.value;

            const marker = new window.AdvancedMarkerElement({
                position: location,
                map: map
            });

            const circle = new google.maps.Circle({
                strokeColor: color,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: color,
                fillOpacity: 0.2,
                map: map,
                center: location,
                radius: 0,
                editable: true,
                draggable: true
            });

            // Create circle data object
            const circleData = {
                id,
                circle,
                marker,
                radius: radiusValue,
                color,
                address: address || 'Unknown Location',
                censusData: null
            };

            // Add to circles array
            circles.push(circleData);

            // Animate circle expanding
            animateCircleRadiusForId(id, 0, targetRadius, CIRCLE_ANIMATION_DURATION, () => {
                fitBoundsToAllCircles();
            });

            // Fetch population data for this circle
            fetchPopulationDataForCircle(id, location.lat(), location.lng());

            // Set up event listeners for this circle
            circle.addListener('radius_changed', () => {
                const cd = circles.find(c => c.id === id);
                if (cd) {
                    cd.radius = Math.round(getRadiusFromMeters(circle.getRadius(), elements.unit.value));
                    updateCircleCard(id);
                    if (activeCircleId === id) {
                        syncRadiusControls(cd.radius);
                    }
                    debouncedUpdatePopulationForCircle(id);
                }
            });

            circle.addListener('center_changed', () => {
                const cd = circles.find(c => c.id === id);
                if (cd) {
                    cd.marker.position = circle.getCenter();
                }
            });

            circle.addListener('dragend', () => {
                const cd = circles.find(c => c.id === id);
                if (cd) {
                    cd.censusData = null;
                    const center = circle.getCenter();
                    fetchPopulationDataForCircle(id, center.lat(), center.lng());
                }
            });

            circle.addListener('click', () => {
                selectCircle(id);
            });

            // Update UI
            updateCirclesPanel();
            selectCircle(id);

            // Show export button if we have circles
            if (circles.length > 0) {
                elements.exportBtn.classList.add('show');
            }
        }

        function removeCircle(id) {
            const index = circles.findIndex(c => c.id === id);
            if (index === -1) return;

            const circleData = circles[index];
            circleData.circle.setMap(null);
            circleData.marker.map = null;

            circles.splice(index, 1);

            // If we removed the active circle, select another one
            if (activeCircleId === id) {
                activeCircleId = circles.length > 0 ? circles[0].id : null;
            }

            updateCirclesPanel();
            updatePopulationPanel();

            // Hide export button if no circles
            if (circles.length === 0) {
                elements.exportBtn.classList.remove('show');
            }
        }

        function clearAllCircles() {
            circles.forEach(cd => {
                cd.circle.setMap(null);
                cd.marker.map = null;
            });
            circles = [];
            activeCircleId = null;
            updateCirclesPanel();
            elements.exportBtn.classList.remove('show');
            closeDrawer();
        }

        function selectCircle(id) {
            activeCircleId = id;
            const circleData = circles.find(c => c.id === id);

            if (circleData) {
                // Update controls to show this circle's values
                elements.radiusInput.value = circleData.radius;
                elements.radiusSlider.value = Math.min(circleData.radius, 500);
                elements.color.value = circleData.color;

                // Highlight selected circle (make others semi-transparent)
                circles.forEach(cd => {
                    const isActive = cd.id === id;
                    cd.circle.setOptions({
                        strokeOpacity: isActive ? 0.8 : 0.4,
                        fillOpacity: isActive ? 0.2 : 0.1,
                        strokeWeight: isActive ? 2 : 1
                    });
                });
            }

            updateCirclesPanel();
            updatePopulationPanel();
        }

        function fitBoundsToAllCircles() {
            if (circles.length === 0) return;

            const bounds = new google.maps.LatLngBounds();
            circles.forEach(cd => {
                bounds.union(cd.circle.getBounds());
            });
            map.fitBounds(bounds);
        }

        function animateCircleRadiusForId(id, startRadius, endRadius, duration, onComplete) {
            const startTime = performance.now();
            const circleData = circles.find(c => c.id === id);
            if (!circleData) return;

            function update(currentTime) {
                const cd = circles.find(c => c.id === id);
                if (!cd) return;

                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentRadius = startRadius + (endRadius - startRadius) * easeOut;

                cd.circle.setRadius(currentRadius);

                if (progress < 1) {
                    requestAnimationFrame(update);
                } else if (onComplete) {
                    onComplete();
                }
            }
            requestAnimationFrame(update);
        }

        function updateCirclesPanel() {
            // Update circle count in drawer header
            elements.circleCount.textContent = `(${circles.length})`;
            elements.drawerBadge.textContent = circles.length;

            // Calculate totals for summary bar
            let totalPopulation = 0;
            let totalListings = 0;
            let totalArea = 0;
            const allCounties = new Set();
            const allStates = new Set();

            circles.forEach(cd => {
                // Calculate area for each circle
                totalArea += Math.PI * cd.radius * cd.radius;

                if (cd.censusData && !cd.censusData.error) {
                    totalPopulation += cd.censusData.totalPopulation;
                    totalListings += Math.round((cd.censusData.totalPopulation / 1000000) * LISTINGS_PER_MILLION);

                    // Track unique counties and states
                    cd.censusData.countiesInRadius.forEach(county => {
                        allCounties.add(`${county.n}, ${county.s}`);
                        allStates.add(county.s);
                    });
                }
            });

            const avgDensity = totalArea > 0 ? Math.round(totalPopulation / totalArea) : 0;

            // Update summary bar with proper pluralization
            const circleLabel = circles.length === 1 ? 'circle' : 'circles';
            elements.summaryCircleCount.textContent = `${circles.length} ${circleLabel}`;
            elements.summaryListings.textContent = `~${formatNumber(totalListings)}`;
            elements.summaryPopulation.textContent = formatNumber(totalPopulation);
            elements.summaryArea.textContent = formatNumber(Math.round(totalArea));
            elements.summaryCounties.textContent = allCounties.size;
            elements.summaryStates.textContent = allStates.size;
            elements.summaryDensity.textContent = formatNumber(avgDensity);

            // Show/hide summary bar and drawer toggle based on circles
            if (circles.length === 0) {
                elements.summaryBar.classList.remove('show');
                elements.drawerToggle.classList.remove('show');
                elements.drawerFooter.style.display = 'none';
                closeDrawer();
            } else {
                elements.summaryBar.classList.add('show');
                elements.drawerToggle.classList.add('show');
                elements.drawerFooter.style.display = 'block';
            }

            // Render circle cards in drawer
            elements.drawerContent.innerHTML = circles.length === 0
                ? '<p style="text-align: center; color: var(--vettx-text-light); padding: 20px;">No circles added yet.<br>Enter an address above to add a market area.</p>'
                : circles.map(cd => {
                    const hasData = cd.censusData && !cd.censusData.error;
                    const listings = hasData
                        ? Math.round((cd.censusData.totalPopulation / 1000000) * LISTINGS_PER_MILLION)
                        : '--';
                    const population = hasData
                        ? formatNumber(cd.censusData.totalPopulation)
                        : '--';
                    const counties = hasData
                        ? cd.censusData.countiesInRadius.length
                        : '--';
                    const states = hasData
                        ? new Set(cd.censusData.countiesInRadius.map(c => c.s)).size
                        : '--';
                    const circleArea = Math.round(Math.PI * cd.radius * cd.radius);
                    const density = hasData
                        ? formatNumber(Math.round(cd.censusData.totalPopulation / circleArea))
                        : '--';
                    const emoji = hasData ? getListingsEmoji(listings) : 'ðŸš—';
                    const isActive = cd.id === activeCircleId;

                    return `
                        <div class="circle-card ${isActive ? 'active' : ''}" data-id="${cd.id}" onclick="selectCircle(${cd.id})">
                            <div class="circle-card-header">
                                <div class="circle-card-color" style="background-color: ${cd.color}"></div>
                                <div class="circle-card-address" title="${cd.address}">${cd.address}</div>
                                <button class="circle-card-delete" onclick="event.stopPropagation(); removeCircle(${cd.id})" title="Remove circle">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div class="circle-card-listings">
                                <span class="circle-card-listings-icon">${emoji}</span>
                                <span class="circle-card-listings-value">~${formatNumber(listings)}</span>
                                <span class="circle-card-listings-label">listings/mo</span>
                            </div>
                            <div class="circle-card-metrics">
                                <div class="circle-card-metric">
                                    <span class="circle-card-metric-value">${population}</span>
                                    <span class="circle-card-metric-label">Population</span>
                                </div>
                                <div class="circle-card-metric">
                                    <span class="circle-card-metric-value">${counties}</span>
                                    <span class="circle-card-metric-label">Counties</span>
                                </div>
                                <div class="circle-card-metric">
                                    <span class="circle-card-metric-value">${states}</span>
                                    <span class="circle-card-metric-label">State${states !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="circle-card-metric">
                                    <span class="circle-card-metric-value">${density}/miÂ²</span>
                                    <span class="circle-card-metric-label">Density</span>
                                </div>
                            </div>
                            <div class="circle-card-controls">
                                <label>Radius:</label>
                                <input type="number" class="circle-card-radius" value="${cd.radius}" min="1" max="500"
                                    onclick="event.stopPropagation()"
                                    onchange="updateCircleRadius(${cd.id}, this.value)">
                                <span class="circle-card-unit">mi</span>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function updateCircleCard(id) {
            const card = document.querySelector(`.circle-card[data-id="${id}"]`);
            if (!card) return;

            const cd = circles.find(c => c.id === id);
            if (!cd) return;

            const listings = cd.censusData ? Math.round((cd.censusData.totalPopulation / 1000000) * LISTINGS_PER_MILLION) : '--';
            const population = cd.censusData ? formatNumber(cd.censusData.totalPopulation) : '--';

            const statsEl = card.querySelector('.circle-card-stats');
            if (statsEl) {
                statsEl.innerHTML = `
                    <span>~${listings} listings/mo</span>
                    <span>Pop: ${population}</span>
                `;
            }

            const radiusInput = card.querySelector('.circle-card-radius');
            if (radiusInput && document.activeElement !== radiusInput) {
                radiusInput.value = cd.radius;
            }
        }

        function updateCircleRadius(id, newRadius) {
            const cd = circles.find(c => c.id === id);
            if (!cd) return;

            newRadius = parseInt(newRadius) || 25;
            cd.radius = newRadius;

            const radiusInMeters = getRadiusInMeters(newRadius, elements.unit.value);
            cd.circle.setRadius(radiusInMeters);

            if (activeCircleId === id) {
                syncRadiusControls(newRadius);
            }

            // Recalculate population
            const center = cd.circle.getCenter();
            fetchPopulationDataForCircle(id, center.lat(), center.lng());
        }

        function debouncedUpdatePopulationForCircle(id) {
            if (populationUpdateTimeout) clearTimeout(populationUpdateTimeout);
            populationUpdateTimeout = setTimeout(() => {
                const cd = circles.find(c => c.id === id);
                if (cd) {
                    const center = cd.circle.getCenter();
                    fetchPopulationDataForCircle(id, center.lat(), center.lng());
                }
            }, DEBOUNCE_DELAY);
        }

        function syncRadiusControls(value) {
            elements.radiusSlider.value = Math.min(Math.round(value), parseFloat(elements.radiusSlider.max));
            elements.radiusInput.value = Math.round(value);
        }

        function handleRadiusChange(e) {
            if (!activeCircleId) return;

            const isSlider = e.target.id === 'radiusSlider';
            const radiusValue = parseFloat(e.target.value) || 1;

            if (isSlider) {
                elements.radiusInput.value = radiusValue;
            } else {
                elements.radiusSlider.value = Math.min(radiusValue, parseFloat(elements.radiusSlider.max));
            }

            updateActiveCircleRadius(radiusValue);
        }

        function handleUnitChange() {
            elements.unitDisplay.textContent = elements.unit.value;
            // Update all circles when unit changes
            circles.forEach(cd => {
                const radiusInMeters = getRadiusInMeters(cd.radius, elements.unit.value);
                cd.circle.setRadius(radiusInMeters);
            });
            fitBoundsToAllCircles();
        }

        function handleColorChange() {
            if (!activeCircleId) return;

            const cd = circles.find(c => c.id === activeCircleId);
            if (cd) {
                const color = elements.color.value;
                cd.color = color;
                cd.circle.setOptions({ strokeColor: color, fillColor: color });
                updateCirclesPanel();
            }
        }

        function updateActiveCircleRadius(radiusValue) {
            if (!activeCircleId) return;

            const cd = circles.find(c => c.id === activeCircleId);
            if (cd) {
                cd.radius = Math.round(radiusValue);
                const radiusInMeters = getRadiusInMeters(radiusValue, elements.unit.value);
                cd.circle.setRadius(radiusInMeters);
                updateCircleCard(activeCircleId);
                debouncedUpdatePopulationForCircle(activeCircleId);
            }
        }

        // Legacy function - keep for compatibility
        function debouncedUpdatePopulation() {
            if (activeCircleId) {
                debouncedUpdatePopulationForCircle(activeCircleId);
            }
        }

        // Remove old unused functions
        function updateCircle(radiusValue) {
            // Deprecated - use updateActiveCircleRadius instead
            updateActiveCircleRadius(radiusValue);
        }

        function oldDebouncedUpdatePopulation() {
            if (populationUpdateTimeout) clearTimeout(populationUpdateTimeout);
            populationUpdateTimeout = setTimeout(() => {
                if (censusData) updatePopulationDisplay();
            }, DEBOUNCE_DELAY);
        }

        // CORS proxy with fallbacks
        async function fetchWithProxy(url) {
            const proxies = [
                (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
                (u) => `https://proxy.cors.sh/${u}`,
                (u) => `https://thingproxy.freeboard.io/fetch/${u}`
            ];

            for (const proxy of proxies) {
                try {
                    const proxyUrl = proxy(url);
                    const response = await fetch(proxyUrl, {
                        headers: { 'Accept': 'application/json' }
                    });
                    if (response.ok) {
                        const text = await response.text();
                        try {
                            return JSON.parse(text);
                        } catch {
                            console.warn('Proxy returned invalid JSON, trying next');
                            continue;
                        }
                    }
                } catch (e) {
                    console.warn('Proxy failed:', e.message);
                }
            }
            throw new Error('All proxies failed. Try disabling Enhanced Tracking Protection or ad blockers.');
        }

        // Square meters to square miles conversion
        const SQ_METERS_TO_SQ_MILES = 3.861e-7;

        async function fetchPopulationDataForCircle(circleId, lat, lng) {
            const cd = circles.find(c => c.id === circleId);
            if (!cd) return;

            try {
                // Check if we have county data loaded
                if (!allCounties || allCounties.length === 0) {
                    console.error('County data not loaded. allCounties:', allCounties);
                    throw new Error('County data not loaded. Please refresh the page.');
                }

                // Get the radius in miles for this specific circle
                let radiusMiles = cd.radius;
                const unit = elements.unit.value;
                if (unit === 'km') {
                    radiusMiles = radiusMiles * 0.621371; // Convert km to miles
                }

                console.log(`Circle ${circleId}: Searching for counties within ${radiusMiles} miles of (${lat}, ${lng})`);

                // Find all counties within the radius using pre-loaded data
                const countiesInRadius = findCountiesInRadius(lat, lng, radiusMiles);

                console.log(`Circle ${circleId}: Found ${countiesInRadius.length} counties`);

                if (countiesInRadius.length === 0) {
                    // Check if location is in US by finding nearest county
                    const nearest = allCounties
                        .map(c => ({ ...c, dist: haversineDistance(lat, lng, c.lat, c.lng) }))
                        .sort((a, b) => a.dist - b.dist)[0];

                    cd.censusData = {
                        error: true,
                        message: nearest && nearest.dist > 500
                            ? 'Location appears to be outside the United States.'
                            : `No counties found. Nearest: ${nearest?.n}, ${nearest?.s} (${nearest?.dist?.toFixed(0)} mi away). Try a larger radius.`
                    };
                } else {
                    // Calculate total population from all counties in radius
                    const totalPopulation = countiesInRadius.reduce((sum, county) => sum + county.p, 0);

                    // Group counties by state for display
                    const stateGroups = {};
                    countiesInRadius.forEach(county => {
                        if (!stateGroups[county.s]) {
                            stateGroups[county.s] = [];
                        }
                        stateGroups[county.s].push(county);
                    });

                    cd.censusData = {
                        centerLat: lat,
                        centerLng: lng,
                        totalPopulation,
                        countiesInRadius,
                        countyCount: countiesInRadius.length,
                        stateGroups,
                        stateCount: Object.keys(stateGroups).length
                    };
                }

                // Update UI
                updateCircleCard(circleId);
                updateCirclesPanel();
                if (activeCircleId === circleId) {
                    updatePopulationPanel();
                }

            } catch (error) {
                console.error('Population calculation error:', error);
                cd.censusData = { error: true, message: error.message };
                updateCircleCard(circleId);
            }
        }

        function updatePopulationPanel() {
            // Now handled by updateCirclesPanel which updates the summary bar
            updateCirclesPanel();

            // Show/hide export button based on circles
            if (circles.length > 0) {
                elements.exportBtn.classList.add('show');
            } else {
                elements.exportBtn.classList.remove('show');
            }
        }

        // PDF Export functionality - supports multiple circles
        async function exportToPDF() {
            if (circles.length === 0) return;

            const btn = elements.exportBtn;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;"></span> Generating...';

            try {
                const { jsPDF } = window.jspdf;

                // Capture map
                const mapElement = document.getElementById('map');
                const mapCanvas = await html2canvas(mapElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2
                });

                // Calculate combined stats from all circles
                let totalPopulation = 0;
                let totalListings = 0;
                let allCounties = new Set();
                let allStates = new Set();

                circles.forEach(cd => {
                    if (cd.censusData && !cd.censusData.error) {
                        totalPopulation += cd.censusData.totalPopulation;
                        totalListings += Math.round((cd.censusData.totalPopulation / 1000000) * LISTINGS_PER_MILLION);
                        cd.censusData.countiesInRadius.forEach(c => {
                            allCounties.add(c.f); // Use FIPS code as unique identifier
                            allStates.add(c.s);
                        });
                    }
                });

                const unit = elements.unit.value;

                // Create PDF (landscape for better map display)
                const pdf = new jsPDF('landscape', 'pt', 'letter');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // Header background
                pdf.setFillColor(24, 29, 49); // vettx-dark-1 #181D31
                pdf.rect(0, 0, pageWidth, 60, 'F');

                // VETTX Logo text - fixed spacing
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(24);
                pdf.setFont('helvetica', 'bold');
                pdf.text('VETT', 40, 38);
                const vettWidth = pdf.getTextWidth('VETT');
                pdf.setTextColor(0, 158, 247); // vettx-brand #009EF7
                pdf.text('X', 40 + vettWidth, 38);
                const xWidth = pdf.getTextWidth('X');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text('Market Radius Report', 40 + vettWidth + xWidth + 15, 38);

                // Date
                pdf.setFontSize(10);
                pdf.setTextColor(180, 180, 180);
                const date = new Date().toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                pdf.text(date, pageWidth - 40, 38, { align: 'right' });

                // Title - depends on number of circles
                pdf.setTextColor(24, 29, 49); // vettx-dark-1
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                const title = circles.length === 1
                    ? circles[0].address
                    : `Market Analysis - ${circles.length} Areas`;
                pdf.text(title, 40, 85);

                // Subtitle
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(136, 143, 151); // vettx-dark-3
                const subtitle = circles.length === 1
                    ? `${circles[0].radius} ${unit} radius | ${allCounties.size} counties | ${allStates.size} state${allStates.size !== 1 ? 's' : ''}`
                    : `${circles.length} circles | ${allCounties.size} unique counties | ${allStates.size} state${allStates.size !== 1 ? 's' : ''}`;
                pdf.text(subtitle, 40, 100);

                // Map image - large, full width at top
                const mapImgData = mapCanvas.toDataURL('image/png');
                const canvasRatio = mapCanvas.width / mapCanvas.height;
                const mapWidth = pageWidth - 80; // 40px margin each side
                const mapHeight = mapWidth / canvasRatio;
                const maxMapHeight = circles.length > 1 ? 220 : 280; // Smaller map if multiple circles
                const finalMapHeight = Math.min(mapHeight, maxMapHeight);
                const finalMapWidth = finalMapHeight === maxMapHeight ? maxMapHeight * canvasRatio : mapWidth;

                pdf.addImage(mapImgData, 'PNG', 40, 115, finalMapWidth, finalMapHeight);

                // Stats section below map
                let statsY = 115 + finalMapHeight + 20;

                // Main stat - Combined Listings (left side, prominent)
                pdf.setFillColor(230, 247, 255); // light brand bg
                pdf.roundedRect(40, statsY, 250, 70, 8, 8, 'F');
                pdf.setFontSize(10);
                pdf.setTextColor(136, 143, 151); // vettx-dark-3
                pdf.text(circles.length > 1 ? 'COMBINED EST. LISTINGS / MONTH' : 'ESTIMATED PRIVATE PARTY LISTINGS / MONTH', 55, statsY + 22);
                pdf.setFontSize(32);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(0, 158, 247); // vettx-brand #009EF7
                pdf.text(`~${formatNumber(totalListings)}`, 55, statsY + 52);

                // Stats grid (right side)
                const stats = [
                    { label: 'Total Population', value: formatNumber(totalPopulation) },
                    { label: 'Counties', value: formatNumber(allCounties.size) },
                    { label: 'States', value: allStates.size.toString() },
                    { label: 'Market Areas', value: circles.length.toString() },
                ];

                const col1X = 310;
                const col2X = 450;
                const statBoxWidth = 130;

                pdf.setFont('helvetica', 'normal');
                stats.forEach((stat, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = col === 0 ? col1X : col2X;
                    const y = statsY + (row * 38);

                    pdf.setFillColor(246, 248, 250); // vettx-light-2
                    pdf.roundedRect(x, y, statBoxWidth, 32, 4, 4, 'F');
                    pdf.setFontSize(8);
                    pdf.setTextColor(136, 143, 151); // vettx-dark-3
                    pdf.text(stat.label.toUpperCase(), x + 10, y + 12);
                    pdf.setFontSize(13);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(24, 29, 49); // vettx-dark-1
                    pdf.text(stat.value, x + 10, y + 25);
                    pdf.setFont('helvetica', 'normal');
                });

                // Per-circle breakdown (if multiple circles)
                if (circles.length > 1) {
                    statsY += 90;
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(24, 29, 49);
                    pdf.text('Per-Area Breakdown:', 40, statsY);
                    statsY += 15;

                    circles.forEach((cd, index) => {
                        if (statsY > pageHeight - 60) return; // Don't overflow page

                        const listings = cd.censusData && !cd.censusData.error
                            ? Math.round((cd.censusData.totalPopulation / 1000000) * LISTINGS_PER_MILLION)
                            : 0;
                        const pop = cd.censusData && !cd.censusData.error
                            ? formatNumber(cd.censusData.totalPopulation)
                            : 'N/A';

                        pdf.setFillColor(246, 248, 250);
                        pdf.roundedRect(40, statsY, pageWidth - 80, 24, 4, 4, 'F');

                        // Color indicator
                        const colorHex = cd.color.replace('#', '');
                        const r = parseInt(colorHex.substring(0, 2), 16);
                        const g = parseInt(colorHex.substring(2, 4), 16);
                        const b = parseInt(colorHex.substring(4, 6), 16);
                        pdf.setFillColor(r, g, b);
                        pdf.circle(55, statsY + 12, 6, 'F');

                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(24, 29, 49);

                        // Truncate address if too long
                        let addr = cd.address;
                        if (addr.length > 50) addr = addr.substring(0, 47) + '...';
                        pdf.text(addr, 70, statsY + 15);

                        pdf.setTextColor(136, 143, 151);
                        pdf.text(`${cd.radius} ${unit}`, 400, statsY + 15);
                        pdf.text(`Pop: ${pop}`, 480, statsY + 15);
                        pdf.setTextColor(0, 158, 247);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(`~${formatNumber(listings)}/mo`, pageWidth - 120, statsY + 15);

                        statsY += 28;
                    });
                }

                // Footer
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(150, 150, 150);
                pdf.text('* Population estimates from 2020 Census county data.', 40, pageHeight - 30);
                pdf.text('Generated by VETTX Market Analysis | www.vettx.com', 40, pageHeight - 15);

                // Save
                const filename = circles.length === 1
                    ? `VETTX-Market-Report-${circles[0].address.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 30)}.pdf`
                    : `VETTX-Market-Report-${circles.length}-Areas.pdf`;
                pdf.save(filename);

            } catch (error) {
                console.error('PDF export error:', error);
                alert('Failed to generate PDF. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function showError(message) {
            elements.error.textContent = message;
            elements.error.classList.add('show');
        }

        function hideError() {
            elements.error.classList.remove('show');
        }
    </script>
    <script>
        // Modern async loading pattern for Google Maps
        (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
            key: "AIzaSyCQF6fsF0cRGXk3ts_4wZ_-Bw1TrBU3hZg",
            v: "weekly"
        });

        // Initialize map after libraries are loaded
        async function init() {
            // Load county data in parallel with Google Maps
            const countyDataPromise = loadCountyData();

            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            const { Geocoder } = await google.maps.importLibrary("geocoding");
            const { Autocomplete } = await google.maps.importLibrary("places");

            window.AdvancedMarkerElement = AdvancedMarkerElement;
            window.GeocoderClass = Geocoder;
            window.AutocompleteClass = Autocomplete;

            await countyDataPromise; // Ensure county data is loaded
            initMap();
        }

        init();
    </script>
</body>
</html>
